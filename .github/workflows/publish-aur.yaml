name: Publish to AUR

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish (e.g., v1.0.4)'
        required: true
        type: string

jobs:
  publish-aur:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || inputs.tag }}

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ inputs.tag }}"
          fi
          VERSION=${TAG#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Download release tarball
        run: |
          wget "https://github.com/Joinsider/dhbw-next/archive/refs/tags/${{ steps.version.outputs.tag }}.tar.gz" -O dhbw-next.tar.gz

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(sha256sum dhbw-next.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "Calculated SHA256: ${SHA256}"

      - name: Update PKGBUILD
        run: |
          sed -i "s/pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" PKGBUILD
          sed -i "s/sha256sums=.*/sha256sums=('${{ steps.sha256.outputs.sha256 }}')/" PKGBUILD

      - name: Generate .SRCINFO
        uses: docker://archlinux:latest
        with:
          args: bash -c "pacman -Syu --noconfirm binutils fakeroot base-devel && cd /github/workspace && makepkg --printsrcinfo > .SRCINFO"

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: dhbw-next
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to version ${{ steps.version.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
